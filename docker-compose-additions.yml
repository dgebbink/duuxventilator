# docker-compose-additions.yml
#
# Merge these additions into your existing Mosquitto docker-compose.yml.
#
# They expose host port 443 (where the fan connects after DNS override) and
# forward it to the TLS listener on container port 8883 defined in
# mosquitto/duux-fan-tls.conf.
#
# ── Option A: Docker Compose override (recommended) ─────────────────────────
# Run both files together — no need to edit your original compose file:
#
#   docker compose \
#     -f docker-compose.yml \
#     -f docker-compose-additions.yml \
#     up -d mosquitto
#
# ── Option B: Manual merge ───────────────────────────────────────────────────
# Copy the relevant blocks below into your existing docker-compose.yml.
# ─────────────────────────────────────────────────────────────────────────────

services:
  mosquitto:
    ports:
      - "443:8883"          # Fan → host:443 → container TLS listener :8883
      # Keep your existing port mappings (e.g. 1883:1883) in the base file.
    volumes:
      - ./certs:/mosquitto/certs:ro
        # Mounts collector3.cloudgarden.nl.{crt,key} generated by certs/generate-certs.sh
      - ./mosquitto:/mosquitto/conf.d:ro
        # Mounts duux-fan-tls.conf (and any other *.conf files in that directory)

# ─────────────────────────────────────────────────────────────────────────────
# Notes
# ─────────────────────────────────────────────────────────────────────────────
#
# 1. Port 443 requires root or NET_BIND_SERVICE capability.
#    If your Docker host complains, add to the mosquitto service:
#
#      cap_add:
#        - NET_BIND_SERVICE
#
#    … or use a firewall/iptables redirect instead:
#      iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 8883
#
# 2. After bringing up the container, verify the TLS port is open:
#      openssl s_client -connect 192.168.2.27:443 -servername collector3.cloudgarden.nl
#    You should see the self-signed cert and a successful handshake.
#
# 3. Then subscribe on the plain port to watch for fan traffic:
#      mosquitto_sub -h 192.168.2.27 -p 1883 -t 'sensor/#' -v
#    Power-cycle the fan; within ~30 s you should see sensor/e0:5a:1b:76:ef:60/online.
